#' @title Simple mediation model
#'
#' @description
#' \code{mdt_simple} fits a simple mediation model using joint significance
#' method (Judd, Yzerbyt, & Muller, 2014).
#'
#' @details
#' Given a dataframe, an IV, a DV and a mediator, fits a mediation model.
#'
#' @references
#' Judd, C. M., Yzerbyt, V. Y., & Muller, D. (2014). Mediation
#' and moderation. Handbook of research methods in
#' social and personality psychology, 2, 653â€“676.
#'
#' @param data a dataframe containing the variables in the model.
#' @param IV an unquoted variable in the data frame which will be used
#'             as independant variable.
#' @param M an unquoted variable in the data frame which will be used
#'             as mediator.
#' @param DV an unquoted variable in the data frame which will be used
#'             as dependant variable.
#'
#' @export

mdt_simple <- function(data, IV, DV, M) {
  UseMethod("mdt_simple")
}

#' @export
mdt_simple.data.frame <- function(data, IV, DV, M) {

  # nse -----------------------------------------------------------------------
  IV_var <- enquo(IV)
  DV_var <- enquo(DV)
  M_var  <- enquo(M)

  IV_name <- rlang::quo_name(IV_var)
  DV_name <- rlang::quo_name(DV_var)
  M_name  <- rlang::quo_name(M_var)

  IV_data <- data %>% dplyr::pull( !! IV_var )
  DV_data <- data %>% dplyr::pull( !! DV_var )
  M_data  <- data %>% dplyr::pull( !! M_var )

  # type check ----------------------------------------------------------------
  if(!is.numeric(IV_data))
    stop(glue::glue("Warning:
                    IV ({IV_name}) must be numeric (see build_contrast() to
                    convert a character vector to a contrast code)."))

  if(!is.numeric(M_data))
    stop(glue::glue("Warning:
                    Mediator ({M_name}) must be numeric."))

  if(!is.numeric(M_data))
    stop(glue::glue("Warning:
                    DV ({DV_name}) must be numeric."))
  # building models -----------------------------------------------------------
  model1 <-
    stats::as.formula(glue::glue("{DV} ~ {IV}",
                                 IV = IV_name,
                                 DV = DV_name))

  model2 <-
    stats::as.formula(glue::glue("{M} ~ {IV}",
                                 IV = IV_name,
                                 M  = M_name))

  model3 <-
    stats::as.formula(glue::glue("{DV} ~ {IV} + {M}",
                                 DV = DV_name,
                                 IV = IV_name,
                                 M  = M_name))

  # models fitting and cleaning -----------------------------------------------
  js_models <-
    list("X -> Y"     = model1,
         "X -> M"     = model2,
         "X + M -> Y" = model3) %>%
    purrr::map(~lm(.x, data))

  js_models_summary <-
    purrr::map(js_models, ~broom::tidy(.x))

  # bulding mediation model object --------------------------------------------
  mediation_model <-
    list(
      type      = "simple mediation",
      method    = "Joint significant",
      model     = list("IV" = IV_name,
                       "DV" = DV_name,
                       "M"  = M_name),
      CI        = FALSE,
      js_models = js_models,
      js_models_summary = js_models_summary,
      data = data)

  as_mediation_model(mediation_model)
}

